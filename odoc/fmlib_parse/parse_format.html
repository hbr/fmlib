<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>parse_format (fmlib_parse.parse_format)</title><meta charset="utf-8"/><link rel="stylesheet" href="../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> – <a href="../index.html">Index</a> &#x00BB; <a href="index.html">fmlib_parse</a> &#x00BB; parse_format</nav><header class="odoc-preamble"><h1 id="format-error-messages-nicely"><a href="#format-error-messages-nicely" class="anchor"></a>Format Error Messages Nicely</h1><p><a href="parse.html" title="parse">Up</a></p><p>As shown in the <a href="parse_error.html" title="parse_error">previous chapter</a> there is support in the combinators to collect expressive information concering errors during parsing. The parsers in this library support the collection of position information as well (only the generic parser has no support for position information).</p><p>At the end of the parsing, the parser has either succeeded or failed because of a syntax error or a semantic error. There are functions like <a href="Fmlib_parse/Character/Make/Parser/index.html#val-failed_expectations" title="Fmlib_parse.Character.Make.Parser.failed_expectations"><code>failed_expectations</code></a> and <a href="Fmlib_parse/Character/Make/Parser/index.html#val-failed_semantic" title="Fmlib_parse.Character.Make.Parser.failed_semantic"><code>failed_semantic</code></a> which return the corresponding error information.</p><p>It is not too difficult to use the error information and print some expressive error messages. However it is tedious to do this by hand. The parsing library has some support to print the error messages nicely.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#form">Form</a></li><li><a href="#syntax-errors">Syntax Errors</a></li><li><a href="#semantic-errors">Semantic Errors</a></li></ul></nav></div><div class="odoc-content"><h2 id="form"><a href="#form" class="anchor"></a>Form</h2><p>Let's look at the <a href="parse_calculator.html" title="parse_calculator">calculator example</a> with the following input:</p><pre>    1
    + 6^2 * 200
    - (100 - 50^3)
    +, 300
    - 2</pre><p>Parsing this input will result in a syntax error at the unexpected comma.</p><p>The functions in this library help us to generate the following error message:</p><pre>
    1 | 1
    2 | + 6^2 * 200
    3 | - (100 - 50^3)
    4 | +, 300
         ^

    At the marker I was expecting one of the following:

        - unary operator
        - number
        - opening parenthesis '(' or '['</pre><p>If we feed the calculator with the input</p><pre>    1 +
    + 6^2 * 200
    - (100 - 50^3)
    + 300 / (100 - 50 - 20 - 30)
    - 2</pre><p>it is possible to generate the error message</p><pre>
    1 | 1
    2 | + 6^2 * 200
    3 | - (100 - 50^3)
    4 | + 300 / (100 - 50 - 20 - 10)
                 ^^^^^^^^^^^^^^^^^^

    Zero divisor</pre><h2 id="syntax-errors"><a href="#syntax-errors" class="anchor"></a>Syntax Errors</h2><p>The module <a href="Fmlib_parse/Error_reporter/index.html" title="Fmlib_parse.Error_reporter"> <code>Error_reporter</code></a> makes the generation of error messages easy.</p><p>Let's assume that we have a failed parser <code>p:Parser.t</code> which has failed because of a syntax error. An error reporter can be generated from <code>p</code> by</p><pre class="language-ocaml"><code>    module Reporter = Error_reporter.Make (Parser)

    let r = Reporter.make_syntax p</code></pre><p>Now we have an error reporter <code>r</code> which can report the error of the parser <code>p</code>. Obviously this is allowed only if the parser <code>p</code> is in an error state <code>not (needs_more p) &amp;&amp; not (has_succeeded p)</code>.</p><p>The error reporter needs some form of the input stream to extract the relevant source snippet. If the parser has read the input from an input channel <code>ic</code> then we can generate the error message by</p><pre class="language-ocaml"><code>    seek_in ic 0;   (* Reposition the input channel to the start. *)

    let doc =
        Reporter.run_on_channel ic r</code></pre><p>The generated <code>doc</code> has type <a href="../fmlib_pretty/Fmlib_pretty/Print/index.html#type-doc"><code>Fmlib_pretty.Print.doc</code></a>. <code>doc</code> is a representation of the error message. The module <a href="../fmlib_pretty/Fmlib_pretty/Print/index.html"><code>Fmlib_pretty.Print</code></a> has functions to layout the message with a certain text width and write the document to a channel (i.e. file), to convert it to a string etc.</p><p>If we want to write the error message to <code>stderr</code> we just issue the call</p><pre class="language-ocaml"><code>    Fmlib_pretty.Print.(
        layout 80 doc       (* Layout with text width 80 *)
        |&gt;
        write_to_channel stderr
    )</code></pre><p>and we are ready.</p><h2 id="semantic-errors"><a href="#semantic-errors" class="anchor"></a>Semantic Errors</h2><p>If the <code>fail</code> combinator has been used in the parser <code>p</code>, then the parser can fail either with a syntax error or a semantic error. Since semantic errors are transparent to the parser (they are encapsuled in the functor argument <code>Semantic</code>) some support is needed from the user to generate the error message.</p><p>The user has to provide two functions to describe the semantic error:</p><ul><li><code>semantic_range: Semantic.t -&gt; Position.range</code>: Compute the start and end position of the semantic error.</li></ul><ul><li><code>semantic_message: Semantic.t -&gt; Fmlib_pretty.Print.doc</code>: Compute the specific error message.</li></ul><p>In the <a href="parse_error.html" title="parse_error">calculator example</a> we have used <code>Position.range * string</code> as the type of semantic errors. The two needed functions are in that case fairly trivial.</p><pre class="language-ocaml"><code>    let semantic_range error =
        fst error

    let semantic_message error =
        snd error
        |&gt;
        Fmlib_pretty.Print.text</code></pre><p>Having a parser <code>p</code> which failed either because of a syntax or semantic error we can generate an error message by</p><pre class="language-ocaml"><code>    seek_in 0 ic;

    Error_reporter.(
        make
            semantic_range
            semantic_message
            p
        |&gt;
        run_on_channel ic
        |&gt;
        Fmlib_pretty.Print.layout 80
        |&gt;
        Fmlib_pretty.write_to_channel stderr
    )</code></pre><p>Because it is very frequent to read from a file represented by an input channel and to write the error message to <code>stderr</code> the above sequence can be shortened to</p><pre class="language-ocaml"><code>    seek_in 0 ic;

    Error_reporter.(
        make
            semantic_range
            semantic_message
            p
        |&gt;
        run_on_channels ic 80 stderr
    )</code></pre><p><a href="parse.html" title="parse">Up</a></p></div></body></html>
