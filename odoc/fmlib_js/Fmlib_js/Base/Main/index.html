<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Main (fmlib_js.Fmlib_js.Base.Main)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../index.html">Index</a> &#x00BB; <a href="../../../index.html">fmlib_js</a> &#x00BB; <a href="../../index.html">Fmlib_js</a> &#x00BB; <a href="../index.html">Base</a> &#x00BB; Main</nav><header class="odoc-preamble"><h1>Module <code><span>Base.Main</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#javascript-exceptions">Javascript Exceptions</a></li><li><a href="#logging">Logging</a></li><li><a href="#node-module">Node Module</a></li><li><a href="#browser-application">Browser Application</a></li><li><a href="#global-environment">Global Environment</a></li></ul></nav></div><div class="odoc-content"><h2 id="javascript-exceptions"><a href="#javascript-exceptions" class="anchor"></a>Javascript Exceptions</h2><div class="odoc-spec"><div class="spec type anchored" id="type-js_error"><a href="#type-js_error" class="anchor"></a><code><span><span class="keyword">type</span> js_error</span></code></div><div class="spec-doc"><p>Type of a javascript exception.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_exception"><a href="#val-of_exception" class="anchor"></a><code><span><span class="keyword">val</span> of_exception : <span>exn <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-js_error">js_error</a> option</span></span></code></div><div class="spec-doc"><p><code>of_exception exn</code> returns <code>Some js_error</code> if the exception <code>exn</code> is an exception raised by javascript code and <code>None</code> if <code>exn</code> is an exception raised by ocaml code.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-raise_js_error"><a href="#val-raise_js_error" class="anchor"></a><code><span><span class="keyword">val</span> raise_js_error : <span><a href="#type-js_error">js_error</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Raise the javascript exception <code>js_error</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-raise_js"><a href="#val-raise_js" class="anchor"></a><code><span><span class="keyword">val</span> raise_js : <span>string <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>raise_js error</code> Raise a javascript exception.</p></div></div><h2 id="logging"><a href="#logging" class="anchor"></a>Logging</h2><div class="odoc-spec"><div class="spec value anchored" id="val-log_string"><a href="#val-log_string" class="anchor"></a><code><span><span class="keyword">val</span> log_string : <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>log_string str</code> Log the string <code>str</code> via <code>console.log</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-log_value"><a href="#val-log_value" class="anchor"></a><code><span><span class="keyword">val</span> log_value : <span><a href="../Value/index.html#type-t">Value.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>log_value v</code> Log the javascript value <code>v</code> via <code>console.log</code>.</p></div></div><h2 id="node-module"><a href="#node-module" class="anchor"></a>Node Module</h2><p>The functions in this section allow the creation of node modules which can interact with the surrounding javascript code. The communication is based on message passing. The javascript side can send messages into the node module implemented in ocaml and the ocaml side can send messages to the javascript side.</p><p>In order to start the node module, initialisation data can be provided.</p><p>The implementation of the node module on the ocaml side is done by providing a function of the following type.</p><div class="odoc-spec"><div class="spec type anchored" id="type-node_function"><a href="#type-node_function" class="anchor"></a><code><span><span class="keyword">type</span> <span>('state, 'msg) node_function</span></span><span> = <span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="../Value/index.html#type-t">Value.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Type of the implementation function of the node module.</p><p>The implementation function has the form</p><pre class="language-ocaml"><code>    let node (state: 'state) (callback: Value.t -&gt; unit): 'msg -&gt; unit =
        ... (* initialisation code *)
        ...
        fun msg -&gt;
            ... (* receive a message from the javascript side *)
            ...</code></pre></div></div><p>Having a node function and a state and a message decoder, a node module is generated by a call to the following function.</p><div class="odoc-spec"><div class="spec value anchored" id="val-node_module"><a href="#val-node_module" class="anchor"></a><code><span><span class="keyword">val</span> node_module : 
  <span><span><span class="type-var">'state</span> <a href="../Decode/index.html#type-t">Decode.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'msg</span> <a href="../Decode/index.html#type-t">Decode.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'state</span>, <span class="type-var">'msg</span>)</span> <a href="#type-node_function">node_function</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>node_module state_decode msg_decode node_function</code></p><p>An ocaml program <code>my_app.ml</code> with an ocaml statement of the form</p><pre class="language-ocaml"><code>    let _ =
        node_module state_decode msg_decode node_function</code></pre><p>compiles to <code>my_app.js</code> which can be loaded as a module in a nodejs script via</p><pre>   var my_app = require('./my_app.js')</pre><p>The javascript value <code>my_app</code> is a javascript object of the form</p><pre>   {init: (initial_state, callback) =&gt; { ... }}</pre><p>which can be used in the following way:</p><pre>    function callback (msg) {
        ...     // actions on receiving a message from 'my_app'
    }
    var state =
             ... // initial state which can be decoded
                 // by 'state_decode'

    var post_to_my_app = my_app.init(state, callback)

    post_to_my_app (msg)    // send message to 'my_app',
                            // must be decodable via 'msg_decode'</pre></div></div><h2 id="browser-application"><a href="#browser-application" class="anchor"></a>Browser Application</h2><p>The function in this section allow the creation of browser applications which can interact with the surrounding javascript code. The communication is base on message passing. The javascript side can send messages into the ocaml browser application and vice versa.</p><p>The implementation of a browser application with javascript interop on the ocaml side is done by providing a function of the following type.</p><div class="odoc-spec"><div class="spec type anchored" id="type-browser_function"><a href="#type-browser_function" class="anchor"></a><code><span><span class="keyword">type</span> <span>('state, 'msg) browser_function</span></span><span> =
  <span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../Value/index.html#type-t">Value.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Type of the implementation function of the browser application with javascript interop.</p></div></div><p>The browser function has the form</p><pre class="language-ocaml"><code>    let browser
        (state: 'state)                 (* initial state *)
        (element: string option)        (* optional element id *)
        (callback: Value.t -&gt; unit)     (* send messages to javascript *)
        : 'msg -&gt; unit
        =
        ... (* initialisation code *)
        ...
        fun msg -&gt;
            ... (* receive a message from the javascript side *)
            ...</code></pre><div class="odoc-spec"><div class="spec value anchored" id="val-browser_application"><a href="#val-browser_application" class="anchor"></a><code><span><span class="keyword">val</span> browser_application : 
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'state</span> <a href="../Decode/index.html#type-t">Decode.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'msg</span> <a href="../Decode/index.html#type-t">Decode.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'state</span>, <span class="type-var">'msg</span>)</span> <a href="#type-browser_function">browser_function</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>browser_application state_decode msg_decode browser_function</code></p><p>An ocaml program <code>my_app.ml</code> with an ocaml statement of the form</p><pre class="language-ocaml"><code>    let _ =
        browser_application
            &quot;my_app&quot;            (* Unique name in the browser *)
            state_decode
            msg_decode
            browser_function</code></pre><p>can be compiled to a javascript file <code>my_app.js</code>. This file <code>my_app.js</code> can be included within a html page in a script tag</p><pre>    &lt;script type=&quot;text/javascript&quot; src=&quot;my_app.js&quot;&gt;&lt;/script&gt;</pre><p>In the html file we need some javascript code to interact with the browser application.</p><pre> &lt;script&gt;
    var state = ...         // javascript value which can be decoded
                            // by 'state_decode'

    var postMessage         // variable representing a function to
                            // post messages to 'my_app'

    var callback (msg) {
        ...                 // actions on receiving messages from
        ...                 // 'my_app'
        ...
        postMessage (...)   // send a message to 'my_app'
    }
    &lt;/script&gt;</pre><p>At the end of the body the application <code>my_app</code> can be started by</p><pre>    &lt;script&gt;
        postMessage = my_app.init (state, 'element_id', callback)
    &lt;/script&gt;</pre><p><em>Warning:</em> The ocaml browser application shall not be initialized before the body and in particular the element is available. Therefore it is best to initialize the application at the end of the html body.</p><p>It is convenient to initialize the browser application with an element id below which the browser application should install itself in the dom tree. This can be used to avoid conflicting dom accesses between the javascript side and the ocaml browser application.</p></div></div><h2 id="global-environment"><a href="#global-environment" class="anchor"></a>Global Environment</h2><p>If your application written in ocaml wants to communicate with javascript code, then the following functions might be interesting.</p><p>With the function <a href="#val-make_global"><code>make_global</code></a> it is possible to make a javascript value generated via ocaml available to the surrounding javascript code. In many cases you will make a function globally available to the javascript code. This function can receive initialization data and callback functions. With the callback functions you can post messages to the surrounding javascript code. Furthermore the globally accessible function might return a function which can be used by the surrounding javscript code to post messages to the ocaml application.</p><p>If you write a web worker, you have to make function with the name <code>onmessage</code> available to the global environment. This function has type <code>Value.t -&gt; Value.t</code> and it usually returns <code>Value.undefined</code>. Via <a href="#val-get_global"><code>get_global</code></a> you can find out, if a function named <code>postMessage</code> exists (it exists in the global environment of a webworker) and then you can use this function to send messages to the creator of the web worker.</p><div class="odoc-spec"><div class="spec value anchored" id="val-make_global"><a href="#val-make_global" class="anchor"></a><code><span><span class="keyword">val</span> make_global : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="../Value/index.html#type-t">Value.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>make_global name value</code> Make the javascript value <code>value</code> accessible from javascript code via the global name <code>name</code>.</p><p>Caution:</p><p>If the global name <code>name</code> already exists, it will be overwritten. This has fatal consequences if you overwrite e.g. <code>setTimeout</code> or <code>document</code> or other other used global variables or global functions.</p><p>It is recommended to use some prefix like <code>my_app_...</code> in <code>name</code> in order to not pollute the global namespace.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_global"><a href="#val-get_global" class="anchor"></a><code><span><span class="keyword">val</span> get_global : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="../Value/index.html#type-t">Value.t</a> option</span></span></code></div><div class="spec-doc"><p><code>get_global name</code> Check, if <code>name</code> exists in the global enviroment and if yes, return the corresponding javascript value. Use <a href="../Decode/index.html"><code>Decode</code></a> to check, if the global is a function, an object, a number etc.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-new_global"><a href="#val-new_global" class="anchor"></a><code><span><span class="keyword">val</span> new_global : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Value/index.html#type-t">Value.t</a> array</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Value/index.html#type-t">Value.t</a></span></code></div><div class="spec-doc"><p><code>new_global constructor args</code></p><p>Construct a new javascript object using the constructor <code>constructor</code> feeding it with the arguments <code>args</code>.</p><p>Precondition: The constructor must exist and it has to accept the arguments. If not, an exception is thrown.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-export"><a href="#val-export" class="anchor"></a><code><span><span class="keyword">val</span> export : <span><span><span>(string * <a href="../Value/index.html#type-t">Value.t</a>)</span> array</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>export [| name1, val1; name2, val2; ... |]</code></p><p>Export the javascript object consisting of the fields <code>name1</code>, <code>name2</code>, ... to the surrounding javascript code.</p><p>This function is used if you want to write a module to be used in a node application. In the javascript code you write</p><pre class="language-ocaml"><code>    var my_app = require('./my_app.js')</code></pre><p>and then the javascript variable <code>my_app</code> is an object containing all the exported fields.</p></div></div></div></body></html>
